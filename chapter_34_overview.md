# **第34章 JaCoCo插件**

Chapter 34. The JaCoCo Plugin

JaCoCo插件目前正在优化中。请注意，DSL和其他配置在以后的Gradle版本中可能会改变。

The JaCoCo plugin is currently incubating. Please be aware that the DSL and other configuration may change in later Gradle versions.

JaCoCo插件提供了Java代码和JaCoCo集成的代码覆盖率。

The JaCoCo plugin provides code coverage metrics for Java code via integration with JaCoCo.

## **34.1 入门指南**

34.1. Getting Started

开始上手，将JaCoCo插件应用到你想要计算代码覆盖的项目中。

To get started, apply the JaCoCo plugin to the project you want to calculate code 
coverage for.

例34.1 JaCoCo插件的应用

Example 34.1. Applying the JaCoCo plugin

build.gradle

```
apply plugin: "jacoco"
```


如果Java插件也应用到你的项目中，创建一个名为jacocoTestReport的新任务，它的结果将取决于测试任务。这个报告可以在$buildDir/reports/jacoco/test目录下找到，默认会生成一个HTML的测试报告。

If the Java plugin is also applied to your project, a new task named jacocoTestReport is created that depends on the test task. The report is available at $buildDir/reports/jacoco/test. By default, a HTML report is generated.

## **34.2.配置JaCoCo插件**

34.2. Configuring the JaCoCo Plugin

JaCoCo插件项目添加一个名为JacocoPluginExtension的类型，它允许JaCoCo配置默认使用在你的构建中。

The JaCoCo plugin adds a project extension named jacoco of type  JacocoPluginExtension, which allows configuring defaults for JaCoCo usage in your  build.

例34.2. JaCoCo 插件配置设置

Example 34.2. Configuring JaCoCo plugin settings

build.gradle
```
jacoco {
    toolVersion = "0.7.1.201405082137"
    reportsDir = file("$buildDir/customJacocoReportDir")
}
```


表34.1  JaCoCo 属性的默认值

Table 34.1. Gradle defaults for JaCoCo properties
|属性	|Gradle 默认值|
|--
|reportsDir	|“$buildDir/reports/jacoco”|

|Property	|Gradle default|
|--
|reportsDir	|“$buildDir/reports/jacoco”|


## **34.3. JaCoCo报告配置**

34.3. JaCoCo Report configuration

JacocoReport任务可以用来生成不同格式的代码覆盖率报告。它实现了标准Gradle类型报告和JacocoReportsContainer类型的公开报告容器。

The JacocoReport task can be used to generate code coverage reports in different formats. It implements the standard Gradle type Reporting and exposes a report  container of type JacocoReportsContainer.

例34.3.配置测试任务

Example 34.3. Configuring test task

build.gradle

```
jacocoTestReport {
    reports {
        xml.enabled false
        csv.enabled false
        html.destination "${buildDir}/jacocoHtml"
    }
}
```
 

## **34.4. JaCoCo的具体任务配置**

34.4. JaCoCo specific task configuration

JaCoCo插件添加一个JacocoTaskExtension 扩展到所有类型的测试任务。这个扩展允许JaCoCo配置特定属性的测试任务。

The JaCoCo plugin adds a JacocoTaskExtension extension to all tasks of type Test. This extension allows the configuration of the JaCoCo specific properties of the test task.

例34.4  配置测试任务

Example 34.4. Configuring test task

build.gradle

```
test {
    jacoco {
        append = false
        destinationFile = file("$buildDir/jacoco/jacocoTest.exec")
        classDumpFile = file("$buildDir/jacoco/classpathdumps")
    }
}
```

表34.2. JaCoCo任务扩展默认值

Table 34.2. Default values of the JaCoCo Task extension

|属性	|Gradle 默认值|
|--
|enabled	|true|
|destPath	|$buildDir/jacoco|
|append	|true|
|includes	|[]|
|excludes	|[]|
|excludeClassLoaders	|[]|
|sessionId	|auto-generated|
|dumpOnExit	|true|
|output	|Output.FILE|
|address	|-|
|port	|-|
|classDumpPath|	-|
|jmx	|false|


|Property	|Gradle default|
|--
|enabled|	true|
|destPath	|$buildDir/jacoco|
|append	|true|
|includes	|[]|
|excludes	|[]|
|excludeClassLoaders|	[]|
|sessionId	|auto-generated|
|dumpOnExit	|true|
|output	|Output.FILE|
|address	|-|
|port	|-|
|classDumpPath	|-|
|jmx	|false|


应用 Java插件将自动增强提供所有类型的任务测试覆盖率信息  ，JaCoCo插件可增强JavaForkOptions 功能  。即任何forks java进程的任务都能够生成覆盖率信息。

While all tasks of type Test are automatically enhanced to provide coverage information when the java plugin has been applied, any task that implements JavaForkOptions can be enhanced by the JaCoCo plugin. That is, any task that forks Java processes can be used to generate coverage information.


例如，你可以配置使用应用程序插件去生成代码覆盖率。

For example you can configure your build to generate code coverage using the application plugin.


例34.5.使用应用程序插件生成代码覆盖率数据

Example 34.5. Using application plugin to generate code coverage data

build.gradle

```
apply plugin: "application"
apply plugin: "jacoco"

mainClassName = "org.gradle.MyMain"

jacoco {
    applyTo run
}

task applicationCodeCoverageReport(type:JacocoReport){
    executionData run
    sourceSets sourceSets.main
}
```

注意：这个例子的代码可以在gradle下的samples/testing/jacoco/application目录中找到。

Note: The code for this example can be found at samples/testing/jacoco/application in the ‘-all’ distribution of Gradle.

例34.6.通过applicationCodeCoverageReport生成覆盖率报告

Example 34.6. Coverage reports generated by applicationCodeCoverageReport

构建布局
```
Build layout
application/
  build/
    jacoco/
      run.exec
    reports/jacoco/applicationCodeCoverageReport/html/
      index.html

```


## **34.5.任务**

34.5. Tasks

对于项目同样适用于Java插件,JaCoCo插件会自动添加以下任务:

For projects that also apply the Java Plugin, The JaCoCo plugin automatically adds the following tasks:

表34.3.JaCoCo插件 - 任务

Table 34.3. JaCoCo plugin - tasks

|任务名称	|依赖于|	类型|	描述|
|--
|jacocoTestReport	|-	|JacocoReport|生成代码覆盖率报告的测试任务|
			

|Task name	|Depends on	|Type	|Description|
|--
|jacocoTestReport	|-	|JacocoReport|Generates code coverage report for the test task.|

## **34.6.依赖管理**

34.6. Dependency management

JaCoCo插件依赖配置添加如下:

The JaCoCo plugin adds the following dependency configurations:


表34.4.JaCoCo插件——依赖配置

Table 34.4. JaCoCo plugin - dependency configurations


|名称	|意义|
|--
|jacocoAnt	|JaCoCo Ant库用于运行JacocoReport和JacocoMerge任务。|
|jacocoAgent	|JaCoCo代理库用于测试插装代码。|



|Name	|Meaning|
|--
|jacocoAnt	|The JaCoCo Ant library used for running the JacocoReport and JacocoMerge tasks.|
|jacocoAgent	|The JaCoCo agent library used for instrumenting the code under test.|


